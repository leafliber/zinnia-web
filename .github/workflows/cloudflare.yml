# Cloudflare Pages 部署工作流
# 功能：自动构建并部署项目到 Cloudflare Pages
name: Deploy to Cloudflare Pages

# 工作流触发条件
on:
  # 推送到 main 分支时触发
  push:
    branches:
      - main
  # Pull Request 到 main 分支时触发
  pull_request:
    branches:
      - main
  # 允许手动触发工作流
  workflow_dispatch:

# 定义任务
jobs:
  # 部署任务
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 步骤1：检出代码
      - name: Checkout 代码
        uses: actions/checkout@v4

      # 步骤2：设置 Node.js 环境
      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # 使用 Node.js 20 版本
          cache: 'npm'         # 缓存 npm 依赖以加速构建

      # 步骤3：安装项目依赖
      - name: 安装依赖
        run: npm ci  # 使用 npm ci 确保依赖版本一致性

      # 步骤4：构建项目
      - name: 构建项目
        run: npm run build
        env:
          # API 基础 URL（从 GitHub Secrets 读取）
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
          # 应用名称（从 GitHub Variables 读取，默认为 'Zinnia'）
          VITE_APP_NAME: ${{ vars.VITE_APP_NAME || 'Zinnia' }}
          # 应用标题（从 GitHub Variables 读取，默认为 '设备监控平台'）
          VITE_APP_TITLE: ${{ vars.VITE_APP_TITLE || '设备监控平台' }}

      # 步骤5：部署到 Cloudflare Pages
      - name: 部署到 Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          # Cloudflare API 令牌（从 GitHub Secrets 读取）
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          # Cloudflare 账户 ID（从 GitHub Secrets 读取）
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          # Cloudflare Pages 项目名称
          projectName: zinnia-web
          # 构建产物目录
          directory: dist
          # 使用 Git 分支作为部署环境名称
          branch: ${{ github.head_ref || github.ref_name }}
          # Wrangler CLI 版本
          wranglerVersion: '3'
